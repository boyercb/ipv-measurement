---
title: "IPV Measurement Memo"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
    code_folding: hide
    collapsed: false
    df_print: paged
---

```{r setup, include=FALSE}
# had to separate this chunk because my Rstudio evaluates it in the working directory 
# instead of the project director even though I changed the global settings.
knitr::opts_chunk$set(
  cache = TRUE,
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
rm(list = ls())
```

```{r}
library(DeclareDesign)
library(tidyverse)
library(knitr)
library(kableExtra)
```

# Introduction
Most evaluations of interventions to reduce intimate partner violence rely on some form of the Conflict Tactics Scale (CTS)^[test] to quantify a participant's experience of violence. This instrument attempts to dissociate acts/behaviors from their personal or social meaning as "violence" by asking the respondent to report the frequency that they have experienced specific acts over a defined recall period.

```{r}
questions <- tribble(
  ~v1, ~v2, ~v3, ~v4, ~v5,
"slapped you or thrown something at you that could hurt you?", "0", "1", "2", "3",
"pushed you or shoved you or pulled your hair?", "0", "1", "2", "3",
"hit you with his fist or with something else that could hurt you?", "0", "1", "2", "3",
"kicked you, dragged you or beaten you up?", "0", "1", "2", "3",
"choked or burnt you on purpose?", "0", "1", "2", "3",
"threatened you with or actually used a gun, knife or other weapon against you?", "0", "1", "2", "3"
)

kable(
  questions, 
  format = "html",
  align = "lcccc",
  caption = "Table 1. Example of questions adapted from CTS for measuring violence.",
  col.names = c(
     "In the past 12 months, how often has your partner...", 
     "Never", "Once", "A few times", "Many times"
  )) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

Traditionally, the researcher collapses the answers to these questions into a single binary outcome representing whether the respondent reports any act of violence during the recall period and uses this as the basis for statistical inference. We believe this outcome is more of a historical consequence rather than the optimal analytical choice from a research perspective. In this paper, we evaluate this coding strategy in terms of its efficiency --i.e. the consequences in terms of the statistical power and precision for answering substantive research questions-- as well as its implications for theory and mechanism of violence reduction. We do this through a simulation study.

# Description of simulation
We begin by assuming a model for violence ($Y$), specifically we assume that it may be modeled as Poisson process governed by a common parameter $\lambda$ that represents the average rate of violence during the defined recall period. 
\[Y \sim \text{Poisson}(\lambda)\]
We choose this model as a starting point because it is relatively straightforward while still matching the empirical data distribution quite well. It also makes some sense as, in probability theory, the Poisson distribution generally describes the probability of observing $k$ events in a finite time period (e.g. in our case, the probability of experincing $k$ instances of a single act of violence over the recall period). Using `R` we can simulate random Poisson observations for a study population of size $N$.

```{r}
simulate_pois <- function(
  N = 500, 
  lambda = 0.5,
  teffect = -0.10
){
  declare_population(N = N) +
    declare_assignment(prob = 0.5) +
    declare_step(
      freq_violence_Z_0 = rpois(N, lambda),
      freq_violence_Z_1 = rpois(N, lambda + teffect),
      any_violence_Z_0 = as.numeric(freq_violence_Z_0 > 0),
      any_violence_Z_1 = as.numeric(freq_violence_Z_1 > 0),
      handler = fabricate
    ) +
    declare_estimand(
      ATE_cont = mean(freq_violence_Z_1 - freq_violence_Z_0),
      ATE_bin = mean(any_violence_Z_1 - any_violence_Z_0)) + 
    declare_reveal(
      assignment_variables = "Z",
      outcome_variables = c("freq_violence", "any_violence")) + 
    declare_estimator(
      any_violence ~ Z,
      estimand = "ATE_bin",
      model = lm_robust,
      label = "binary outcome") + 
    declare_estimator(
      freq_violence ~ Z,
      estimand = "ATE_cont",
      model = lm_robust,
      label = "continuous outcome")
}

design <- simulate_pois()
df <- draw_data(design)

ggplot(df, aes(x = freq_violence_Z_0)) +
  geom_bar(aes(y = ..prop..)) +
  geom_text(
    aes(label = round(prop, 2), y = prop + 0.01),
    position = position_dodge(0.9),
    size = 3,
    vjust = 0,
    data = df %>% group_by(freq_violence_Z_0) %>% summarise(prop = n() / nrow(df))
  ) +
  labs(title = "PMF of Simulated Violent Events",
       subtitle = "Poisson(0.3)",
       x = "Violent Events (x)",
       y = "Density"
  )
```

Next, we simulate a hypothetical randomized intervention study by constructing two counterfactual outcomes representing, for each individual, their value of $Y$ if given the intervention and their value of $Y$ if not given the intervention.
\[
Y^{z} \begin{cases}
Y^0 & \text{counterfactual number of violent events under no intervention} \\
Y^1 & \text{counterfactual number of violent events under intervention}
\end{cases}
\]
We simulate $Y^0$ as a Poisson random variable with $\lambda = 0.3$, representing a baseline frequency of violence that matches that of our empirical sample. We then calculate $Y^1$ for each individual as their counterfactual value under no intervention plus the effect of the intervention, i.e.
\[Y^1 = Y^0 + \tau\]
We consider possible values of $\tau$ between -0.3 (complete cessation for all) and 0 (no effect for any individual).
```{r, eval=F}
questions <- tribble(
  ~v1, ~v2, 
"$\\tau_1$", "",
"$\\tau_2$", "",
"$\\tau_3$", "",
"$\\tau_4$", ""
)

kable(
  questions, 
  format = "html",
  align = "ll",
  caption = "Table 2. Treatment effects.",
  escape = F,
  col.names = c(
     "Effect", 
     "Description"
  )) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

We define two different coding strategies for the violent event outcomes. The first strategy is to collapse $Y^{z}$ into a single binary measure, i.e.
\[
Y^{z}_{binary} = 
\begin{cases}
0 & \text{if } Y^{z} = 0 \\
1 & \text{if } Y^{z} \geq 1 \\
\end{cases}
\]
The second is to leave it as a continuous measure
\[Y^{z}_{continuous} = Y^{z}\]

These simulated individuals are then randomly assigned to either an intervention $Z=1$ or no intervention condition $Z=0$ that determines which counterfactual outcome they reveal (i.e. $Y^{1}_{binary}$ vs. $Y^{0}_{binary}$ and $Y^{1}_{continuous}$ vs. $Y^{0}_{continuous}$) and finally we estimate treatment effect as we would in the real world using regressions of the form.

\[\text{E}[Y \mid Z] = \beta_0 + \beta_1 Z\]

We do this using the `DeclareDesign`^[https://declaredesign.org] package in `R` which provides a robust set of 

# Results
```{r}
# Let's see how SE depends on mean ----------------------------------------

teffects <- lapply(seq(-0.3, 0, .01), rep, 10)

means_designs <- 
  expand_design(designer = simulate_pois,
                lambda = list(rep(0.3, 10)), 
                teffect = teffects,
                expand = TRUE) 

diagnoses <- diagnose_designs(means_designs, sims = 1000)

get_diagnosands(diagnoses) %>% 
  left_join(data.frame(
    teffects = sapply(teffects, unique), 
    design_label = paste0("design_",1:length(teffects))
  )) %>% 
  ggplot(aes(x = teffects, y = mean_se, 
             color = estimator_label, 
             group = estimator_label)) +
  geom_point()

get_diagnosands(diagnoses) %>% 
  left_join(data.frame(
    teffects = sapply(teffects, unique), 
    design_label = paste0("design_",1:length(teffects))
  )) %>% 
  ggplot(aes(x = teffects, y = power, 
             color = estimator_label, 
             group = estimator_label)) +
  geom_point()
```